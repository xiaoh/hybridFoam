#!/bin/bash

# A script to cat time series generated by OF


if [ x$1 = "x-h" ]; then
    echo "Concatenate time series in probes and forces directories. "
    echo "Usage: Change into an OpenFOAM case dir, and then issue command:"
    echo "    timeSeriesCat [probeDirs]"
    echo "If you time sieries are not in the default locations, you can provide them as arguments"
    exit 0
fi

if [ $# -lt 1 ]; then
    probeDirs="probesL probesR/RANS forces forcesR"
else
    probeDirs="$@"
fi

catResultsInDir() 
{
    if [ $# -lt 1 ]; then
        operateDir="probes"
    else
        operateDir=$1
    fi
    
    timeDirs=$(ls -l $operateDir | grep ^d | awk '{print $9}' | grep -E '^[0-9]+(\.[0-9]+)?$'  | sort -n)

    echo "Operating on dir: $operateDir"

    timeArray=( $timeDirs )
    N=${#timeArray[@]}
    M=`expr $N - 1`

    for field in `echo $operateDir/0/*`; do
        echo "processing quantity: $field "
        fieldName=$(basename $field)
        dest=$operateDir/$fieldName
        if [ -f $dest ]; then
            /bin/rm $dest
        fi
        touch $dest
        
        for i in $(seq 0 $M); do
            time="${timeArray[i]}"
            cat $operateDir/$time/$fieldName >> $dest
        done
        
        sed -i -e 's/)//g' -e 's/(//g' $dest
    done
    echo " "
}


for dir in $probeDirs; do
    if [ -d $dir ]; then
        catResultsInDir $dir
    else
        echo "$dir does not exist or does not contain time dirs"
        echo "Maybe you mean its subdirs? e.g. specify probesR/RANS instead of probesR"
    fi
done
